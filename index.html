<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Lightning out test</title>
  </head>
  <body>
  <section>
      <button onclick="authorize()">Authorize</button>
      <button onclick="getToken()">getToken</button>
      <button onclick="checkAuthToken()">check authToken</button>
  </section>

    <button onclick="createCart()">create Cart</button>

    <label for="productidinput">Product Id</label>
    <input id="productidinput" type="text">

    <button onclick="setNewId()">Add Product</button>
    <button onclick="runApex()">runApex</button>
    
  <div id="lightning"></div>
  <script src="https://enterprise-site-9357.scratch.my.site.com/student/lightning/lightning.out.js"></script>
  <script>

    function runApex(){
      let temp = lwc.getContactId();
      console.log(temp);
    }

    function getToken(){
      console.log("getToken");
      let paramStringList = location.href.split("?")[1]?.split("&");
      let params = {};
      for(let paramString of paramStringList){
        let keyValue = paramString.split("=");
        params[keyValue[0]] = keyValue[1];
      }

      console.log('params', params);
      console.log('params.code', params.code);

      const client_id = "3MVG931doue2KUvySSE.Yo.gSGrbORWHO5Bdu5C.UlzeJXTxXnqIUftCgFpReOiPvMlk9OPgNeCbsfP0cdF4N";
      const client_secret = "A77F4A8C1DC18E772D2B0AB660D087385D4F93684A9F2B3E931B59321D1E86E8";
      const response_type = "code";
      const baseURL = "https://enterprise-site-9357.my.salesforce.com/services/oauth2/token";
      const redirect_uri = "https://vmjelde.github.io/lightning-out";
      const grant_type = "authorization_code";
      const code = params.code;
      
      const requestURL = baseURL + "?grant_type=" + grant_type + "&code=" + code + "&client_id=" + client_id + "&redirect_uri=" + redirect_uri;

      let xhttp = new XMLHttpRequest();
      xhttp.open("POST", requestURL);
      xhttp.send();


      xhttp.onload = ()=>{
        console.log(xhttp.response);
        let resp = JSON.parse(xhttp.response);
        for(let param in resp){
          console.log(param + ': ' + resp[param]);
        }
        authToken = resp.access_token;
      }

      xhttp.onreadystatechange = () => {
        if (xhttp.readyState === xhttp.HEADERS_RECEIVED) {
          console.log("heisann peisann");
          const contentType = xhttp.getResponseHeader("Content-Type");
        }
      }
    }

    function authorize(){
      location.href = "https://enterprise-site-9357.my.site.com/student/services/oauth2/authorize?client_id=3MVG931doue2KUvySSE.Yo.gSGrbORWHO5Bdu5C.UlzeJXTxXnqIUftCgFpReOiPvMlk9OPgNeCbsfP0cdF4N&redirect_uri=https://vmjelde.github.io/lightning-out&response_type=code";
    }
    function setNewId(){
        let value = document.getElementById('productidinput').value;
        lwc.productId = value;
        lwc.debugFromLWC('Du tastet inn: ' + value);
    }

    function checkAuthToken(){
      console.log(authToken);
    }
        
    var lwc;
    const appName = 'c:LightningOut';
    const componentName = 'c:lightningOutCart';
    const lightningEndPointURI = 'https://enterprise-site-9357.my.site.com/student';
    // Target element er dom element componenten skal henges p√•
    const targetElement = 'lightning';
    const componentAttributes = {};
    var authToken ='';

    function createCart(){
      console.log('creat')
      $Lightning.use(
          appName,
          function() {
          $Lightning.createComponent(
              componentName,
              componentAttributes,
              targetElement,
              function(cmp) {
                  lwc = cmp.elements[0];
                  console.log("LWC component was created");
              }
          );
      },
      lightningEndPointURI,
      authToken
      );
    }

  </script>

  <style>
    section{
      margin-bottom: 1rem;
    }
  </style>

  </body>
</html>